const chalk = require("chalk");
const fse = require('fs-extra');
const fs = require("fs");
const path = require('path');
const toml = require('@iarna/toml');
const execSync = require('child_process').execSync;

function template(
    outdir = "./out", 
    target = "browser", 
    format = "esm", 
    splitting = false, 
    sourcemap = "none", 
    minify = false, 
    naming = "./[name].[ext]", 
    root = "."
) {
    return  `# !bunbuild | Do not edit this file manually; automatically generated.\nfiles=[]\n[settings]\noutdir = "${outdir}"\ntarget = "${target}"\nformat = "${format}"\nsplitting = "${splitting}"\nsourcemap = "${sourcemap}"\nminify = "${minify}"\nnaming = "${naming}"\nroot = "${root}"`;
}

const templates = {
    esm_browser: template(
        "./out", 
        "browser", 
        "esm"
    ),
    esm_browser_library: template(
        "./out",
        "browser",
        "esm",
        false,
        "external",
        true
    ),
    esm_bun: template(
        "./out", 
        "bun", 
        "esm"
    ),
    esm_bun_library: template(
        "./out",
        "bun",
        "esm",
        false,
        "external",
        true
    ),
    esm_node: template( 
        "./out", 
        "node", 
        "esm"
    ),
    esm_node_library: template(
        "./out",
        "node",
        "esm",
        false,
        "external",
        true
    ),
};

const bbicon = [
    chalk.bgCyanBright.cyanBright("██████"),
    chalk.bgCyanBright.cyanBright("█")+chalk.bgCyanBright.white.bold(".BUN")+chalk.bgCyanBright.cyanBright("█"),
    chalk.bgCyanBright.white.bold("BUILD")+chalk.bgCyanBright.cyanBright("█")
]; 

exports.templateBuildfile = function(tname) {
    const root = process.cwd();
    const appPath = path.join(root, "./.bunbuild");

    console.log(chalk.bgCyanBright.black.bold("[Bun Build]")+chalk.bgBlack.blue.italic(" $ Init:Template"));
    if (appPath == root) {
        return;
    }
    if (fse.existsSync(appPath)) {
        console.log(chalk.bgCyanBright.black.bold("[Bun Build]")+chalk.bgBlack.redBright(" Error | Bunbuild file already exists"));
        process.exit(1);
    } else {
        if (templates[tname] != undefined) {
            fs.writeFileSync(appPath, templates[tname]);
            console.log(chalk.bgCyanBright.black.bold("[Bun Build]")+chalk.bgBlack.greenBright(" Successfully Created BunBuild File!")+"      "+bbicon[0]);
            console.log(                                                                "                                                     "+bbicon[1]);
            console.log(                                                                "                                                     "+bbicon[2]);
        } else {
            console.log(chalk.bgCyanBright.black.bold("[Bun Build]")+chalk.bgBlack.redBright(" Error | Template Not Found!"));
        }
    }
}